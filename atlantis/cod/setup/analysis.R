# analyzing the output from final gadget run from using gadget.iterative in run.R

#source('~/R/rgadget/trunk/gadgetFileIO.R') ## gadget.fit function doesn't work when this is read in
#source('~/R/rgadget/trunk/gadgetfunctions.R')
#source('~/R/rgadget/trunk/gadgetClass.R')
#source('~/R/rgadget/trunk/gadgetMethods.R')
#source('~/R/rgadget/trunk/function.R')

library(plyr)
library(dplyr)
library(ggplot2)
library(grid)
library(Rgadget)
setwd('~/gadget/models/atlantis/cod/codVersions/codMod31')
fit <- gadget.fit(wgts="WGTS", main.file='WGTS/main.final',
                  fleet.predict = data.frame(fleet = 'bmt.comm', ratio=1),
                  mat.par=c(-6.510198, 1.108594),
                  printfile.printatstart = 0,
                  printfile.steps = 1)

# source('~/R/rgadget/trunk/gadgetFileIO.R')
# source('~/R/rgadget/trunk/gadgetfunctions.R')
# source('~/R/rgadget/trunk/gadgetClass.R')
# source('~/R/rgadget/trunk/gadgetMethods.R')
# source('~/R/rgadget/trunk/function.R')
# 
# gssForward <-
#     gadget.forward(years=6,params.file='WGTS/params.final',
#                    stochastic=FALSE,
#                    num.trials=1,
#                    effort=0.2)

## fit statistics
resTable <- fit$resTable[tail(head(names(fit$resTable),-2),-1)]

summary.plot <-
    ggplot(filter(fit$likelihoodsummary, year != 'all'),
           aes(as.numeric(year), likelihood.value)) +
    geom_point() + facet_wrap(~component, scales="free_y") +theme_bw()+
    xlab('Year') + ylab('Score')


## to calculate biomass index
tmp <- mutate(fit$sidat, survey = ifelse(substr(name,1,3)=='aut','aut', 'igfs'))
tmp <- rbind.fill(tmp,
                  ddply(tmp,~year+survey, summarise,
                        number.x = sum(number.x*0.008249352*lower^3.026918 ),
                        predict = sum(predict*0.008249352*lower^3.026918 ),
                        upper = sum(upper*0.008249352*lower^3.026918 ),
                        lower = sum(lower*0.008249352*lower^3.026918 ),
                        length = 'Biomass'))

# plot the model survey data over the actual survey data
si.spr <-
    ggplot(subset(tmp, survey=='igfs'), aes(year,number.x)) +
    geom_point() +
    geom_line(aes(year,predict)) +
    geom_linerange(data=subset(tmp,year==max(year)),
                   aes(year,ymax=number.x,ymin=predict),col='green')+
    geom_text(data=mutate(subset(tmp,year==min(year)),y=Inf),
              aes(year,y,label=length), vjust = 2,hjust = -1)+
    facet_wrap(~length,scale='free_y',ncol=2) + theme_bw() +
    ylab('Index') + xlab('Year') +
    theme (panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank())

si.aut <-
    ggplot(filter(tmp, survey=='aut'), aes(year,number.x)) +
    geom_point() +
    geom_line(aes(year,predict)) +
    geom_linerange(data=subset(tmp,year==max(year)),
                   aes(year,ymax=number.x,ymin=predict),col='green')+
    geom_text(data=mutate(subset(tmp,year==min(year)),y=Inf),
              aes(year,y,label=length), vjust = 2,hjust = -1)+
    facet_wrap(~length,scale='free_y',ncol=2) + theme_bw() +
    ylab('Index') + xlab('Year') +
    theme (panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank())


# plot the survey length-distribution data over the actual survey length-distribution data
ldist.spr <-
    ggplot(subset(fit$catchdist.fleets,name == 'ldist.spr') ,
           aes(lower,predicted)) + geom_line() +
    geom_line(aes(lower,observed), color='gray') +
    facet_wrap(~year+step) + theme_bw() + 
    geom_text(data=mutate(subset(fit$catchdist.fleets,
                                 name == 'ldist.spr' & lower==min(lower)),y=Inf),
              aes(lower,y,label=year), vjust = 2,hjust = -1)+
    ylab('Proportion') + xlab('length') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank()) 

ldist.aut <-
    ggplot(subset(fit$catchdist.fleets,name == 'ldist.aut') ,
           aes(lower,predicted)) + geom_line() +
    geom_line(aes(lower,observed),col='gray') +
    facet_wrap(~year+step) + theme_bw() + 
    geom_text(data=mutate(subset(fit$catchdist.fleets,
                                 name == 'ldist.aut' & lower==min(lower)),y=Inf),
              aes(lower,y,label=year), vjust = 2,hjust = -1)+
    ylab('Proportion') + xlab('length') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank())


# plot the model catchdistribution data over actual catchdistribution data
ldist.catch <-
    ggplot(subset(fit$catchdist.fleets,name == 'ldist.comm'),
           aes(lower,predicted)) +
    geom_line(aes(lower,observed),col='gray') +
    facet_wrap(~year+step) + theme_bw() + geom_line() +
    geom_text(data=mutate(subset(fit$catchdist.fleets,
                                 name == 'ldist.comm' & lower==min(lower)),y=Inf),
              aes(lower,y,label=year), vjust = 2,hjust = -1)+
    ylab('Proportion') + xlab('length') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank())

ldist.discards <-
    ggplot(subset(fit$catchdist.fleets,name == 'ldist.discards'),
           aes(lower,predicted)) +
    geom_line(aes(lower,observed),col='gray') +
    facet_wrap(~year+step) + theme_bw() + geom_line() +
    geom_text(data=mutate(subset(fit$catchdist.fleets,
                                 name == 'ldist.discards' & lower==min(lower)),y=Inf),
              aes(lower,y,label=year), vjust = 2,hjust = -1)+
    ylab('Proportion') + xlab('length') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank())

ages <- 
    fit$catchdist.fleets %>%
    filter(name %in% c('aldist.spr', 'aldist.aut', 'aldist.comm')) %>%
    group_by(name, year, step, age) %>%
    summarize(observed = sum(observed, na.rm=T),
              predicted = sum(predicted, na.rm=T)) %>%
    mutate(age = as.numeric(gsub('age', '', age)))

aldist.spr <-
    ggplot(data=filter(ages, name=='aldist.spr'), aes(x=age, y=predicted)) + 
    geom_line() + geom_line(aes(x=age, y=observed), color='lightgray') +
    facet_wrap(~year+step) + theme_bw() + 
    geom_text(data=filter(ages, name == 'aldist.spr' & age == max(age)),
              aes(x=max(age)/(4/3), y=Inf, label=year), vjust = 1.5) +
    ylab('Proportion') + xlab('age') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank()) 

aldist.aut <-
    ggplot(data=filter(ages, name=='aldist.aut'), aes(x=age, y=predicted)) + 
    geom_line() + geom_line(aes(x=age, y=observed), color='lightgray') +
    facet_wrap(~year+step) + theme_bw() + 
    geom_text(data=filter(ages, name == 'aldist.aut' & age == max(age)),
              aes(x=max(age)/(4/3), y=Inf, label=year), vjust = 1.5) +
    ylab('Proportion') + xlab('age') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank())

aldist.catch <-
    ggplot(data=filter(ages, name=='aldist.comm'), aes(x=age, y=predicted)) + 
    geom_line() + geom_line(aes(x=age, y=observed), color='lightgray') +
    facet_wrap(~year+step) + theme_bw() + 
    geom_text(data=filter(ages, name == 'aldist.comm' & age == max(age)),
              aes(x=max(age)/(4/3), y=Inf, label=year), vjust = 1.5) +
    ylab('Proportion') + xlab('age') +
    theme (axis.text.y = element_blank(), axis.ticks.y = element_blank(),
           panel.spacing = unit(0,'cm'), plot.margin = unit(c(0,0,0,0),'cm'),
           strip.background = element_blank(), strip.text.x = element_blank()) 



# plot suitability against length for both survey and commercial fleets
selection.plot <-
    ggplot(fit$suitability,
           aes(l,suit,lty=fleet)) +
    geom_line() +
    theme_bw() + ylab('Suitability') + xlab('Length') +
    theme(legend.position = c(0.8,0.25), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm')) 


# plot growth curve from model
gr.plot <-
    ggplot(fit$stock.growth,
           aes(age,length)) + 
    geom_line() +
    theme_bw() + ylab('Length') + xlab('Age') +
    theme(legend.position = c(0.9,0.75), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm'))


# plot recruitment of stock by year
rec.plot <-
    ggplot(fit$res.by.year,aes(year,recruitment/1e6)) +
    geom_bar(stat='identity') +
    ylab("Recruitment (in millions)") + xlab('Year') +  theme_bw() +
    theme(legend.position = c(0.25,0.75), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm')) 

# plotting the catch by year
catch.plot <- 
    ggplot(fit$res.by.year,aes(year,catch/1000)) +
    geom_bar(stat='identity') +
    ylab("Catches (in tons)") + xlab('Year') +  theme_bw() +
    theme(legend.position = c(0.25,0.75), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm'))


# plotting the biomass by year
biomass.plot <- 
    ggplot(fit$res.by.year,aes(year,total.biomass/1000)) +
    geom_bar(stat='identity') +
    ylab("Total biomass (in tons)") + xlab('Year') +  theme_bw() +
    theme(legend.position = c(0.25,0.75), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm')) #+
#facet_wrap(~stock, scales="free_y")


# plotting the harvest per year
harv.plot <- 
    ggplot(fit$res.by.year,aes(year,harv.biomass/1000)) +
    geom_bar(stat='identity') +
    ylab("Harvestable biomass (in tons)") + xlab('Year') +  theme_bw() +
    theme(legend.position = c(0.25,0.75), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm')) #+
#facet_wrap(~stock, scales="free_y")


# plot sustainable stock biomass per year
ssb.plot <- 
    ggplot(fit$res.by.year,aes(year,ssb/1000)) +
    geom_bar(stat='identity') +
    ylab("SSB (in tons)") + xlab('Year') +  theme_bw() +
    theme(legend.position = c(0.25,0.75), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm'))

f.plot <- 
    ggplot(fit$res.by.year, aes(year, F)) + 
    geom_line() + 
    ylab("F") + xlab("Year") +  theme_bw() +
    theme(legend.position=c(0.2, 0.8), legend.title = element_blank(),
          plot.margin = unit(c(0,0,0,0),'cm'))

### these are just some basic plots to check parameters, initial vals, etc.

# check initial values
init.plot <- 
    ggplot(filter(fit$stock.std, year == min(year)),
                  aes(x=age, y=number/1e6)) + geom_bar(stat='identity') + 
    ylab("Number (millions)") + xlab('Age') + theme_bw()


# check natural mortality across ages
params <- read.gadget.parameters('cod/codVersions/codMod30/WGTS/params.final')
m.function <- function(age,nat.m, max.m) {
    exp((-1)*nat.m*age)*max.m
}
curve(m.function(x, 0.02, 0.2963635), 0, 20)
